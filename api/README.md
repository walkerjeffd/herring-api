Mystic Herring Migration - API
==============================

## Configuration

See `/config/index.template.js`

```js
{
  api: {
    url: 'http://localhost:8000', // api url (for access from apps)
    port: 8000,                   // api listening port
    static: {
      // paths to static folders containing app builds
      videoWatch: '../video-watch/dist',
      videoStatus: '../video-status/dist',
      visTemp: '../vis-temp/dist'
    }
  },
  ...
}
```

## Run Server

Run local development server

```
# sudo ufw allow <config.api.port>     # open port, if necessary
npm start
```

Run production server using pm2

```
pm2 start server.js --name herring-api
```

## Responses

All responses follow the general format:

```json
{
  "status": "ok"|"error",
  "data": { ... },         // if ok
  "error": {               // if error
    "data": { ... },
    "message": <text>
  }
}
```

## Endpoints

```js
GET  /watch   // get video to watch
GET  /status  // get count status
POST /count   // submit count
```

### `/watch`

**Query Parameters**

Limit random sample to subset of entire collection.

```js
?id=<videos.id::int>                       // specific video
?date=<videos.start_timestamp::yyyy-mm-dd> // date recorded
?location=<locations.id::text>             // location id
```

**Response**

Returns array of video objects with length 0 or 1. Array has length of 0 if no videos are available based on query parameters.

```json
{
  "status": "ok",
  "data": [{
    "id": <int>,
    "created_at": <timestamp utc>,
    "url": <url>,
    "filename": <filename>,
    "duration": <real>,
    "filesize": <int>,
    "start_timestamp": <timestamp utc>,
    "end_timestamp": <timestamp utc>,
    "location_id": <text>,
    "flagged": <boolean>
  }]
}
```

### `/status`

**Query Parameters**

None

**Response**

Returns object containing `videos` and `counts`.

```json
{
  "status": "ok",
  "data": {
    "videos": {
      "summary": {
        "n": <int>,        // total videos available
        "n_watched": <int> // number of videos with at least one count
      }
    },
    "counts": {
      "summary": {
        "n": <int>,   // total number of counts
        "sum": <int>  // total number of fish counted
      },
      "daily": [
        // daily time series of counts by day
        {
          "date": <timestamp>, // date count submitted
          "n": <int>,          // number of counts
          "sum": <int>         // total number of fish counted
        },
        ...
      ]
    }
  }
}
```


### `/count`

**Query Parameters**

None

**Request**

Request body in json format

```json
{
  "video_id": <int>,   // references video.id
  "count": <int>,      // number of fish counted
  "comment": "<text>", // comment about video
  "session": "<uuid>"  // session id (UUID) generated by client
}
```

**Response**

Returns new count object in json format.

```json
{
  "status": "ok",
  "data": [
    {
      "id": <int>,
      "created_at": <timestamp utc>,
      "video_id": <int>,
      "session": <uuid text>,
      "count": <int>,
      "comment": <text>,
      "flagged": <bool>
    }
  ]
}
```
