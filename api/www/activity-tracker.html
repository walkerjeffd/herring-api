<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Activity Tracker</title>
</head>
<body>
<span id="loading">Loading</span>
<div id="chart-count"></div>
<div id="chart-count-2"></div>
<div id="chart-video"></div>
<div id="chart-count-today"></div>

</body>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>

<script>
Highcharts.setOptions({
  global: {
    useUTC: false
  }
});

var dateFormat = d3.timeFormat('%b %d');
var timestampFormat = d3.timeFormat('%b %d %I:%M %p')

function drawCountChart (data) {
  Highcharts.chart('chart-count', {
    chart: {
      type: 'bubble',
      width: 900,
      // height: 900,
      zoomType: 'xy'
    },
    title: {
      text: 'Activity Tracker: By Count Timestamp (when video was counted)'
    },
    xAxis: {
      type: 'datetime',
      dateTimeLabelFormats: {
        month: '%b %d',
        day: '%b %d'
      },
      title: {
        text: 'Date'
      }
    },
    yAxis: {
      title: {
        text: 'Hour'
      },
      min: -2,
      max: 26,
      tickInterval: 4
    },
    plotOptions: {
      bubble: {
        marker: {
          opacity: 0.2,
          fillOpacity: 0.1
        }
      }
    },
    legend: {
      enabled: false
    },
    tooltip: {
      useHTML: true,
      headerFormat: '<table>',
      pointFormat: '<tr><th># Fish Counted:</th><td>{point.z}</td></tr>' +
        '<tr><th>Counted At:</th><td>{point.count_timestamp}</td></tr>' +
        '<tr><th>Recorded At:</th><td>{point.video_timestamp}</td></tr>',
        // '<tr><th>Video ID:</th><td>{point.video_id}</td></tr>',
      footerFormat: '</table>',
      followPointer: true
    },
    series: [
      {
        name: 'Video Count',
        data: data.map(function (d) {
          return {
            x: d.count_date.valueOf(),
            y: d.count_time,
            z: d.count,
            date: dateFormat(d.count_date),
            video_id: d.video_id,
            video_timestamp: timestampFormat(d.video_timestamp),
            count_timestamp: timestampFormat(d.count_timestamp)
          }
        })
      }
    ]
  })
}

function drawCountChart2 (data) {
  Highcharts.chart('chart-count-2', {
    chart: {
      type: 'scatter',
      width: 900,
      zoomType: 'xy'
    },
    title: {
      text: 'Activity Tracker: By Count Timestamp (when video was counted)'
    },
    subtitle: {
      text: 'No bubble sizing'
    },
    xAxis: {
      type: 'datetime',
      dateTimeLabelFormats: {
        month: '%b %d',
        day: '%b %d'
      },
      title: {
        text: 'Date'
      }
    },
    yAxis: {
      title: {
        text: 'Hour'
      },
      min: -2,
      max: 26,
      tickInterval: 4
    },
    plotOptions: {
      scatter: {
        marker: {
          opacity: 0.2,
          radius: 5
        }
      }
    },
    legend: {
      enabled: false
    },
    series: [
      {
        name: 'Video Count',
        data: data.map(function (d) {
          return [d.count_date.valueOf(), d.count_time];
        })
      }
    ]
  })
}

function drawVideoChart (data) {
  Highcharts.chart('chart-video', {
    chart: {
      type: 'bubble',
      width: 900,
      zoomType: 'xy'
    },
    title: {
      text: 'Activity Tracker: By Video Timestamp (when video was recorded)'
    },
    xAxis: {
      type: 'datetime',
      dateTimeLabelFormats: {
        month: '%b %d',
        day: '%b %d'
      },
      title: {
        text: 'Date'
      }
    },
    yAxis: {
      title: {
        text: 'Hour'
      },
      min: -2,
      max: 26,
      tickInterval: 4
    },
    plotOptions: {
      bubble: {
        marker: {
          opacity: 0.2,
          fillOpacity: 0.1
        }
      }
    },
    legend: {
      enabled: false
    },
    tooltip: {
      useHTML: true,
      headerFormat: '<table>',
      pointFormat: '<tr><th># Fish Counted:</th><td>{point.z}</td></tr>' +
        '<tr><th>Counted At:</th><td>{point.count_timestamp}</td></tr>' +
        '<tr><th>Recorded At:</th><td>{point.video_timestamp}</td></tr>',
        // '<tr><th>Video ID:</th><td>{point.video_id}</td></tr>',
      footerFormat: '</table>',
      followPointer: true
    },
    series: [
      {
        name: 'Video Count',
        data: data.map(function (d) {
          return {
            x: d.video_date.valueOf(),
            y: d.video_time,
            z: d.count,
            date: dateFormat(d.count_date),
            video_id: d.video_id,
            video_timestamp: timestampFormat(d.video_timestamp),
            count_timestamp: timestampFormat(d.count_timestamp)
          }
        })
      }
    ]
  })
}


function drawCountTodayChart (data) {
  Highcharts.chart('chart-count-today', {
    chart: {
      type: 'scatter',
      width: 900,
      zoomType: 'xy'
    },
    title: {
      text: 'Activity Tracker (Today): By Count Timestamp (when video was counted)'
    },
    subtitle: {
      text: 'No bubble sizing'
    },
    xAxis: {
      type: 'datetime',
      dateTimeLabelFormats: {
        month: '%b %d',
        day: '%b %d',
        hour: '%H:%M'
      },
      title: {
        text: 'Time'
      }
    },
    yAxis: {
      title: {
        text: '# Fish Counted'
      },
      min: 0
    },
    plotOptions: {
      scatter: {
        marker: {
          opacity: 0.2,
          radius: 5
        }
      }
    },
    legend: {
      enabled: false
    },
    series: [
      {
        name: 'Video Count',
        data: data.map(function (d) {
          return [d.count_timestamp.valueOf(), d.count];
        })
      }
    ]
  })
}

d3.csv("https://myrwa-api.org/api/herring/datasets/herring-dataset.csv")
  .row(function (d) {
    return {
      video_id: +d.video_id,
      video_url: d.video_url,
      video_duration: +d.video_duration,
      video_timestamp: new Date(d.video_start_timestamp),
      count_timestamp: (d.count === "" ? null : new Date(d.count_timestamp)),
      count: (d.count === "" ? null : +d.count),
      flagged: (d.video_flagged === "TRUE" || d.count_flagged === "TRUE")
    }
  })
  .get(function (data) {
    window.data = data = data
      .filter(function (d) {
        return d.count !== null && !d.flagged;
      })

    data.forEach(function (d) {
      d.video_date = d3.timeDay.floor(d.video_timestamp);
      d.video_time = d.video_timestamp.getHours() + d.video_timestamp.getMinutes() / 60;
      d.count_date = d3.timeDay.floor(d.count_timestamp);
      d.count_time = d.count_timestamp.getHours() + d.count_timestamp.getMinutes() / 60;
    })

    var today = d3.timeDay.floor(new Date());
    var countData = data.filter(function (d) {
      return d.count_date >= d3.timeDay.offset(today, -7);
    });
    var videoData = data.filter(function (d) {
      return d.video_date >= d3.timeDay.offset(today, -7);
    });
    var todayData = data.filter(function (d, i) {
      return (d.count_timestamp - today) > 0;
    });

    d3.select('#loading').style('display', 'none');

    drawCountChart(countData);
    // drawCountChart2(countData);
    drawVideoChart(videoData);
    drawCountTodayChart(todayData);
  });
</script>

</html>